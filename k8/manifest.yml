apiVersion: v1
kind: Namespace
metadata:
  name: ftp-test

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: ftp-pv
  namespace: ftp-test
spec:
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 10Gi
  hostPath:
    path: /data # adjust path on host
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ftp-pvc
  namespace: ftp-test
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ftp-server
  namespace: ftp-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ftp-server
  template:
    metadata:
      labels:
        app: ftp-server
    spec:
      containers:
        - name: ftp
          image: dogsbody.azurecr.io/vsftpd_container:latest
          imagePullPolicy: Always
          imagePullSecrets:
            - name: dogbodys-registry
          ports:
            - containerPort: 21   # FTP
            - containerPort: 22   # SFTP
            - containerPort: 10000
            - containerPort: 10250
          env:
            - name: USER_CONFIG_PATH
              value: "/etc/vsftpd/users.json"
            - name: PASV_MIN_PORT
              value: "10000"
            - name: PASV_MAX_PORT
              value: "10250"
            - name: PASV_ADDRESS
              value: "127.0.0.1"
          volumeMounts:
            - name: user-config
              mountPath: /etc/vsftpd/users.json
              subPath: users.json
              readOnly: true
            - name: ftp-storage
              mountPath: /data
      volumes:
        - name: user-config
          configMap:
            name: ftp-users
        - name: gcs-key
          secret:
            secretName: gcs-sa-secret
        - name: ftp-storage
          persistentVolumeClaim:
            claimName: ftp-pvc

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ftp-users
  namespace: ftp-test
data:
  users.json: |
    {
      "aaron": "$y$j9T$QGcBtB4.9NtptjoDgOGB51$hcIe4Ei4nM39rW.6pYBcVQjBHBRv0Jh4UdpeJA5C0x5",
      "plainftp": "$6$BWZe/CFWGwBT4QTL$jB7eibRC0F99aIIf2dZJhut9xmTwrNkzqpx41nRLgFIY9ISkiCD8Y5457qTLoRzCLGKGUp9dEok1NCsd.2Ty0/",
      "sftp": "$6$BWZe/CFWGwBT4QTL$jB7eibRC0F99aIIf2dZJhut9xmTwrNkzqpx41nRLgFIY9ISkiCD8Y5457qTLoRzCLGKGUp9dEok1NCsd.2Ty0/"
    }

---
apiVersion: v1
kind: Service
metadata:
  name: ftp-svc
  namespace: ftp-test
spec:
  type: NodePort
  selector:
    app: ftp-server
  ports:
    - port: 21
      targetPort: 21
      nodePort: 30210
      name: ftp
    - port: 22
      targetPort: 22
      nodePort: 30022
      name: sftp
    - port: 10000
      targetPort: 10000
      nodePort: 31000
      name: pasv-start
    - port: 10250
      targetPort: 10250
      nodePort: 31250
      name: pasv-end
